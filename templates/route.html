<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ROUTEGUESSR</title>
    <link href="{{ url_for('static', filename='styles/route_style.css')}}" rel="stylesheet"/>
    <link rel="icon" type="image/png" href="../static/images/ROUTEGUESSR.png">
</head>
<body>
    <section class="back">
        <div class="text-box">
            <div class="content-container">
                <div class="route-info">
                    <div class="image-container">
                        <img src="{{ image_url }}" alt="Route Image">
                    </div>
                </div>

                <div class="map-container">
                    <div class="map-box">
                        <div class="map-title">üìç Make Your Guess</div>
                        <div id="map"></div>
                        <div class="guess-info" id="guessInfo" style="display: none;">
                            <div><strong>Your Guess:</strong></div>
                            <div class="coordinates" id="coordinates"></div>
                        </div>

                        <!-- Form to submit coordinates -->
                        <form id="guessForm" action="/submit-guess/{{ operation_id }}" method="POST" style="display: none;">
                            <input type="hidden" id="latInput" name="lat" value="">
                            <input type="hidden" id="lngInput" name="lng" value="">
                        </form>

                        <div class="controls">
                            <div class="map-instructions" id="mapInstructions">
                                Click anywhere on the map to place your guess marker
                            </div>
                            <button class="submit-btn" id="submitBtn" onclick="submitGuess()">
                                Submit Guess
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
<script src="https://maps.googleapis.com/maps/api/js?key={{ maps_key }}&callback=initMap" async defer></script>
<script>
    let map;
    let guessMarker = null; // Tracks the pin on the map
    let guessCoordinates = null; // Stores lat/lng of the pin

    // Get operation_id from Flask template
    const operationId = "{{ operation_id }}";

    function initMap() {
        const mapOptions = {
            center: { lat: {{ area_lat }}, lng: {{ area_lon }} },
            zoom: 12,
            streetViewControl: false,
            rotateControl: false,
            fullscreenControl: true,
            clickableIcons: false,
            mapTypeId: google.maps.MapTypeId.TERRAIN
        };

        map = new google.maps.Map(document.getElementById('map'), mapOptions);

        // LISTENER: When user clicks map, place a pin
        map.addListener('click', function(event) {
            placePin(event.latLng);
        });
    }

    // PLACE PIN: Remove old pin, add new pin, save coordinates
    function placePin(location) {
        // Remove old pin if it exists
        if (guessMarker) {
            guessMarker.setMap(null);
        }

        // Create new pin at clicked location
        guessMarker = new google.maps.Marker({
            position: location,
            map: map,
            title: "Your Guess"
        });

        // Save the lat/lng coordinates
        guessCoordinates = {
            lat: location.lat(),
            lng: location.lng()
        };

        const submitBtn = document.getElementById('submitBtn');
        const instructions = document.getElementById('mapInstructions');
        submitBtn.classList.add('visible');
        instructions.classList.add('hidden');

        // Update hidden form inputs with coordinates
        document.getElementById('latInput').value = guessCoordinates.lat;
        document.getElementById('lngInput').value = guessCoordinates.lng;

        console.log("Pin placed at:", guessCoordinates); // For testing
    }

    function submitGuess() {
        if (!guessCoordinates) {
            alert('Please place a pin on the map first!');
            return;
        }

        // Submit the form which will redirect to single_result
        document.getElementById('guessForm').submit();
    }

    // Initialize the demo map
    document.addEventListener('DOMContentLoaded', function() {
        initMap();
    });
</script>
</body>
</html>