<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ROUTEGUESSR - LEGENDARY LINES</title>
    <link href="{{ url_for('static', filename='styles/legendary_lines_base.css')}}" rel="stylesheet"/>
    <link href="{{ url_for('static', filename='styles/legendary_lines_level.css')}}" rel="stylesheet"/>
</head>
<body>
    <div class="overlay" id="overlay"></div>
    <div class="mobile-menu momo-regular" id="mobileMenu">
        <nav>
            <a href="/">Home</a>
            <a href="/about">About</a>
            <a href="/leaderboard">Leaderboard</a>
            <a href="/privacy">Privacy Policy</a>
        </nav>
    </div>
    <div class="hamburger" id="hamburger">
        <span></span>
        <span></span>
        <span></span>
    </div>
    <div class="gradient-layer"></div>
    <div class="particle-container" id="particleContainer"></div>
    <div class="background-layer"></div>
    <a class="gradient-title anton-regular" href="/">ROUTEGUESSR</a>
    <div class="container">
        <div class="archivo-regular page-title">LEGENDARY LINES</div>
        <div class="description-container">
            <div class="chat-header">
                <span class="bebas-neue-regular">Route Description</span>
                <div class="chat-help-icon gabarito-regular">?</div>
            </div>
            <div class="description-body" id="descriptionBody">
                <div class="description-message">
                    <div class="message-content gabarito-regular"></div>
                </div>
            </div>
            <div class="hint-footer">
                <div class="hint-trigger bebas-neue-regular" id="hintTrigger">
                    HINT
                    <div class="hint-tooltip">Guess 3 wrong to unlock a hint</div>
                </div>
            </div>
        </div>
        <div class="search-container">
            <div class="search-wrapper">
                <input type="text" class="search-input beb" id="routeSearch" placeholder="Search for a route..." autocomplete="off">
            </div>
        </div>
        <div class="guesses-container" id="guessesContainer">
            <div class="guesses-list" id="guessesList"></div>
        </div>
        <div class="selection-container" id="searchResultsContainer">
            <div class="area-list">
                <div class="list-item active"></div>
            </div>
            <div class="list-preview">

            </div>
        </div>
    </div>
    <script>
        const hamburger = document.getElementById('hamburger');
        const mobileMenu = document.getElementById('mobileMenu');
        const overlay = document.getElementById('overlay');

        function toggleMenu() {
            hamburger.classList.toggle('active');
            mobileMenu.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        hamburger.addEventListener('click', toggleMenu);
        overlay.addEventListener('click', toggleMenu);
        document.querySelectorAll('.mobile-menu a').forEach(link => link.addEventListener('click', toggleMenu));

        const areaId = "{{ area_id }}";
        const source = new EventSource(`/api/ll/stream/${areaId}`);
        const container = document.querySelector('.message-content');
        container.textContent = '';
        container.innerHTML = '<div class="loading-dots"><span></span><span></span><span></span></div>';

        let textBuffer = '';
        let typing = false;
        let chunkDelay = 25;
        let fullSummary = '';
        let storedHint = '';

        function typeNextChunk() {
            if (textBuffer.length === 0) {
                typing = false;
                return;
            }

            let chunkSize = Math.min(5, textBuffer.length);
            let spaceIndex = textBuffer.indexOf(' ', 1);
            if (spaceIndex !== -1 && spaceIndex <= 5) {
                chunkSize = spaceIndex + 1;
            }

            const chunk = textBuffer.substring(0, chunkSize);
            container.textContent += chunk;
            textBuffer = textBuffer.substring(chunkSize);

            setTimeout(typeNextChunk, chunkDelay);
        }

        function enqueueText(text) {
            const dots = container.querySelector('.loading-dots');
            if (dots) dots.remove();

            textBuffer += text;
            if (!typing) {
                typing = true;
                typeNextChunk();
            }
        }

        source.onmessage = (event) => {
            if (event.data === '[HINT_DONE]') {
                source.close();
                return;
            }

            if (event.data === '[DONE]') {
                return;
            }

            if (event.data.startsWith('ROUTE_ID:')) {
                correctRouteId = parseInt(event.data.split(':')[1]);
                return;
            }

            if (event.data.startsWith('[HINT]:')) {
                storedHint += event.data.slice(7);
                return;
            }

            fullSummary += event.data;
            enqueueText(event.data);
        };

        let allRoutes = [];
        let correctRouteId = null;
        let correctRoute = null;
        let guesses = [];
        let wrongGuessCount = 0;
        let hintRequested = false;
        const searchInput = document.getElementById('routeSearch');
        const searchContainer = document.querySelector('.search-container');
        const searchResultsContainer = document.getElementById('searchResultsContainer');
        const guessesContainer = document.getElementById('guessesContainer');
        const guessesList = document.getElementById('guessesList');
        const areaList = document.querySelector('.area-list');
        const descriptionBody = document.getElementById('descriptionBody');
        const hintTrigger = document.getElementById('hintTrigger');

        hintTrigger.addEventListener('click', () => {
            if (hintTrigger.classList.contains('unlocked')) {
                displayStoredHint();
                hintTrigger.classList.remove('unlocked');
                hintTrigger.classList.add('used');
                hintTrigger.querySelector('.hint-tooltip').textContent = 'Hint used';
            }
        });

        async function loadRoutes() {
            try {
                const response = await fetch(`/api/ll/search?area_id=${areaId}`);
                const routes = await response.json();
                allRoutes = routes;
            } catch (error) {
                console.error('Error loading routes:', error);
            }
        }

        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.trim().toLowerCase();

            if (query.length === 0) {
                searchResultsContainer.style.display = 'none';
                guessesContainer.classList.add('active');
                return;
            }

            searchResultsContainer.style.display = 'block';
            guessesContainer.classList.remove('active');

            const filteredRoutes = allRoutes.filter(route =>
                route.route_name.toLowerCase().includes(query)
            );


            displayResults(filteredRoutes);
        });

        function displayResults(routes) {
            areaList.innerHTML = '';

            if (routes.length === 0) {
                areaList.innerHTML = '<div class="no-results">No routes found</div>';
                return;
            }

            const container = document.createElement('div');
            container.className = 'routes-container';

            const headerLabels = document.createElement('div');
            headerLabels.className = 'header-labels';
            headerLabels.innerHTML = `
                <div class="label-cell">ROUTE NAME</div>
                <div class="label-cell">GRADE</div>
                <div class="label-cell">TYPE</div>
                <div class="label-cell">PITCHES</div>
                <div class="label-cell">LENGTH</div>
                <div class="label-cell">PRO</div>
                <div class="label-cell">AREA</div>
                <div class="label-cell">CRAG</div>
            `;
            container.appendChild(headerLabels);

            const limitedRoutes = routes.slice(0, 10);

            limitedRoutes.forEach(route => {
                const routeRow = document.createElement('div');
                routeRow.className = 'route-row';
                routeRow.innerHTML = `
                    <div class="route-box-cell">${route.route_name}</div>
                    <div class="route-box-cell">${route.grade || 'N/A'}</div>
                    <div class="route-box-cell">${route.route_type || 'N/A'}</div>
                    <div class="route-box-cell">${route.pitches || 'N/A'}</div>
                    <div class="route-box-cell">${route.length ? route.length + 'ft' : 'N/A'}</div>
                    <div class="route-box-cell">${route.protection_rating || 'N/A'}</div>
                    <div class="route-box-cell">${route.main_area || 'N/A'}</div>
                    <div class="route-box-cell">${route.crag || 'N/A'}</div>
                `;

                routeRow.addEventListener('click', () => {
                    selectRoute(route);
                });

                container.appendChild(routeRow);
            });

            areaList.appendChild(container);
        }

        const GRADE_ORDER = [
            '5.0','5.1','5.2','5.3','5.4','5.5',
            '5.6','5.6+','5.7-','5.7','5.7+',
            '5.8-','5.8','5.8+','5.9-','5.9','5.9+',
            '5.10-','5.10a','5.10a/b','5.10b','5.10','5.10b/c','5.10c','5.10c/d','5.10d','5.10+',
            '5.11-','5.11a','5.11a/b','5.11b','5.11','5.11b/c','5.11c','5.11c/d','5.11d','5.11+',
            '5.12-','5.12a','5.12a/b','5.12b','5.12','5.12b/c','5.12c','5.12c/d','5.12d','5.12+',
            '5.13-','5.13a','5.13a/b','5.13b','5.13','5.13b/c','5.13c','5.13c/d','5.13d','5.13+',
            '5.14-','5.14a','5.14a/b','5.14b','5.14','5.14b/c','5.14c','5.14c/d','5.14d','5.14+',
            '5.15-','5.15a','5.15a/b','5.15b','5.15','5.15b/c','5.15c','5.15c/d','5.15d','5.15+',
            'V0-','V0','V1','V2','V3','V4','V5','V6','V7','V8',
            'V9','V10','V11','V12','V13','V14','V15','V16','V17'
        ];
        const gradeIndex = Object.fromEntries(GRADE_ORDER.map((g, i) => [g, i]));

        function compareOrdinal(guessVal, correctVal, orderMap) {
            if (guessVal === correctVal) return { correct: true };
            const gi = orderMap[guessVal];
            const ci = orderMap[correctVal];
            if (gi === undefined || ci === undefined) return { correct: false };
            return { correct: false, direction: ci > gi ? 'up' : 'down' };
        }

        function compareNumeric(guessVal, correctVal) {
            if (guessVal === correctVal) return { correct: true };
            if (guessVal == null || correctVal == null) return { correct: false };
            return { correct: false, direction: correctVal > guessVal ? 'up' : 'down' };
        }

        function compareRoutes(guessedRoute, correctRoute) {
            return {
                route_name: { correct: guessedRoute.route_name === correctRoute.route_name },
                grade: compareOrdinal(guessedRoute.grade, correctRoute.grade, gradeIndex),
                route_type: { correct: guessedRoute.route_type === correctRoute.route_type },
                pitches: compareNumeric(guessedRoute.pitches, correctRoute.pitches),
                length: compareNumeric(guessedRoute.length, correctRoute.length),
                protection_rating: { correct: guessedRoute.protection_rating === correctRoute.protection_rating },
                main_area: { correct: guessedRoute.main_area === correctRoute.main_area },
                crag: { correct: guessedRoute.crag === correctRoute.crag }
            };
        }

        function makeCell(value, comparison) {
            const cls = comparison.correct ? 'correct' : 'incorrect';
            const arrow = (!comparison.correct && comparison.direction)
                ? `<span class="direction-arrow">${comparison.direction === 'up' ? '↑' : '↓'}</span>`
                : '';
            return `<div class="route-box-cell ${cls}">${value}${arrow}</div>`;
        }

        function displayGuesses() {
            guessesList.innerHTML = '';

            if (guesses.length === 0) {
                return;
            }

            const container = document.createElement('div');
            container.className = 'routes-container';

            const headerLabels = document.createElement('div');
            headerLabels.className = 'header-labels';
            headerLabels.innerHTML = `
                <div class="label-cell">ROUTE NAME</div>
                <div class="label-cell">GRADE</div>
                <div class="label-cell">TYPE</div>
                <div class="label-cell">PITCHES</div>
                <div class="label-cell">LENGTH</div>
                <div class="label-cell">PRO</div>
                <div class="label-cell">AREA</div>
                <div class="label-cell">CRAG</div>
            `;
            container.appendChild(headerLabels);

            guesses.slice().reverse().forEach(guess => {
                const routeRow = document.createElement('div');
                routeRow.className = 'route-row guess-row';

                const route = guess.route;
                const comparison = guess.comparison;

                routeRow.innerHTML =
                    makeCell(route.route_name, comparison.route_name) +
                    makeCell(route.grade || 'N/A', comparison.grade) +
                    makeCell(route.route_type || 'N/A', comparison.route_type) +
                    makeCell(route.pitches || 'N/A', comparison.pitches) +
                    makeCell(route.length ? route.length + 'ft' : 'N/A', comparison.length) +
                    makeCell(route.protection_rating || 'N/A', comparison.protection_rating) +
                    makeCell(route.main_area || 'N/A', comparison.main_area) +
                    makeCell(route.crag || 'N/A', comparison.crag);

                container.appendChild(routeRow);
            });

            guessesList.appendChild(container);
        }

        function displayStoredHint() {
            if (hintRequested) return;
            hintRequested = true;

            const hintMessage = document.createElement('div');
            hintMessage.className = 'description-message';
            const hintContent = document.createElement('div');
            hintContent.className = 'message-content gabarito-regular';
            hintMessage.appendChild(hintContent);
            descriptionBody.appendChild(hintMessage);

            let hintTextBuffer = storedHint;

            function typeNextHintChunk() {
                if (hintTextBuffer.length === 0) return;

                let chunkSize = Math.min(5, hintTextBuffer.length);
                const spaceIndex = hintTextBuffer.indexOf(' ', 1);
                if (spaceIndex !== -1 && spaceIndex <= 5) chunkSize = spaceIndex + 1;

                hintContent.textContent += hintTextBuffer.substring(0, chunkSize);
                hintTextBuffer = hintTextBuffer.substring(chunkSize);

                setTimeout(typeNextHintChunk, chunkDelay);
            }

            typeNextHintChunk();
        }

        function selectRoute(route) {
            console.log('Selected route:', route);

            if (!correctRoute && correctRouteId) {
                correctRoute = allRoutes.find(r => parseInt(r.route_id) === correctRouteId);
            }

            if (!correctRoute) {
                console.error('Correct route not found yet');
                wrongGuessCount += 1;
                return;
            }

            const comparison = compareRoutes(route, correctRoute);

            guesses.push({
                route: route,
                comparison: comparison
            });

            searchInput.value = '';
            searchResultsContainer.style.display = 'none';

            displayGuesses();
            guessesContainer.classList.add('active');

            const guessedRouteId = parseInt(route.route_id);
            if (guessedRouteId === correctRouteId) {
                console.log('Correct Guess');
                searchContainer.style.display = 'none';
            } else {
                console.log('Incorrect Guess');
                wrongGuessCount++;

                if (wrongGuessCount === 3) {
                    hintTrigger.classList.add('unlocked');
                    hintTrigger.querySelector('.hint-tooltip').textContent = 'Click for a hint';
                }
            }
        }

        loadRoutes();

        searchResultsContainer.style.display = 'none';
        guessesContainer.classList.remove('active');
    </script>
</body>
</html>