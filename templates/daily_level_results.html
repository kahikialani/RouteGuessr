{% extends "base.html" %}

{% block styles %}
    <link href="{{ url_for('static', filename='styles/daily_level_result.css')}}" rel = "stylesheet"/>
{% endblock %}

{% block content %}
    <div class="logo-container">
        <a href="/" class="logo-link">
            <img src="{{ url_for('static', filename='images/ROUTEGUESSR.png') }}" alt="RouteGuessr Logo" class="logo">
        </a>
    </div>
    <section class="back">
        <div class="score-card">
            <h2>Level: {{ level }}/{{ total_levels }}</h2>
            <h2>Score: {{ total_score }}</h2>
        </div>
        <div class="text-box">
            <div class="content-container">
                <div class="route-info">
                    <div class="image-container">
                        <img src="{{ image_link }}" alt="Route Image">
                    </div>
                </div>
                <div class="map-container">
                    <div class = "route-info-box">
                        <div class = "route-name">
                            <a href="{{ route_link }}" target ="_blank">{{ route_name }}</a>
                        </div>
                        <div class = "route-grade saira-regular">
                            {{ route_grade }} - {{ route_type }} - Length: {{ route_length }} ft - {{ route_stars }} out of 4 average stars.
                        </div>
                    </div>
                    <div class = "map-box">
                        <div id="map"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class = "score-box">
            <div class="score-bar-container">
                <div class="score-bar" style="width: {{ (score / 5000) * 100 }}%;"></div>
                <div class="score-text saira-regular">{{ score }}  /  5000</div>
            </div>
            <div class = "distance-text saira-bold">
                Your guess was {{ distance_str }} away from the true location!
            </div>
            <div class="button-container">
                {% if level < total_levels %}
                    <button class="next-btn saira-bold" onclick="nextLevel()">
                        Next Level
                    </button>
                {% else %}
                    <button class="next-btn saira-bold" onclick="finishChallenge()">
                        View Final Results
                    </button>
                {% endif %}
            </div>
        </div>
    </section>
    <script>
        const userLat = {{ user_lat }};
        const userLon = {{ user_lon }};
        const routeLat = {{ route_lat }};
        const routeLon = {{ route_lon }};
        const userPosition = { lat: userLat, lng: userLon };
        const routePosition = { lat: routeLat, lng: routeLon };


        let map;

        async function initMap() {
            const { Map } = await google.maps.importLibrary("maps");

            map = new Map(document.getElementById("map"), {
                center: { lat: {{ avg_lat }}, lng: {{ avg_lon }} },
                zoom: {{ zoom_level }},
                streetViewControl: false,
                rotateControl: false,
                fullscreenControl: true,
                clickableIcons: false,
                mapTypeId: google.maps.MapTypeId.HYBRID
            });

            const userMarker = new google.maps.Marker({
                position: userPosition,
                map: map,
                title: "Your Guess",
                icon: {
                    url: "{{ url_for('static', filename='images/man.png') }}",
                    scaledSize: new google.maps.Size(32,32)
                }
            });

            const routeMarker = new google.maps.Marker({
                position: routePosition,
                map: map,
                title: "Actual Route Location",
                icon: {
                    url: "{{ url_for('static', filename='images/home.png') }}",
                    scaledSize: new google.maps.Size(32,32)
                }
            });

            const line = new google.maps.Polyline({
                path: [userPosition, routePosition],
                geodesic: true,
                strokeColor: "#333333",
                strokeOpacity: 0,
                strokeWeight: 0,
                icons: [{
                    icon: {
                        path: 'M 0,-1 0,1',
                        strokeOpacity: 1,
                        strokeColor: '#333333',
                        scale: 3
                    },
                    offset: '5%',
                    repeat: '15px'
                }]
            });

            line.setMap(map);
        }

        initMap();
    </script>
    <script>
        function nextLevel() {
            window.location.href = `/daily/level/{{ level + 1 }}`;
        }

        function finishChallenge() {
            window.location.href = `/daily/results`;
        }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key={{ maps_key }}&callback=initMap" async defer></script>
{% endblock %}

