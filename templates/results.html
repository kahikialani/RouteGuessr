<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ROUTE-GUESSR</title>
    <link href="{{ url_for('static', filename='styles/results_style.css')}}" rel="stylesheet"/>
</head>
<body>
    <section class="back">
        <div class="text-box">
            <p style="font-size: 2rem;">Route Found!</p>

            <div class="content-container">
                <div class="route-info">
                    <div class="image-container">
                        <img src="{{ image_url }}" alt="Route Image">
                    </div>
                    <p><a href="{{ route_url }}" target="_blank">View Route Details</a></p>
                </div>

                <div class="map-container">
                    <div class="map-box">
                        <div class="map-title">üìç Make Your Guess</div>
                        <div id="map" style="height: 400px; width: 100%;"></div>

                        <div class="map-instructions">
                            Click anywhere on the map to place your guess marker
                        </div>

                        <div class="guess-info" id="guessInfo" style="display: none;">
                            <div><strong>Your Guess:</strong></div>
                            <div class="coordinates" id="coordinates"></div>
                        </div>

                        <div class="controls">
                            <button class="submit-btn" id="submitBtn" onclick="submitGuess()" disabled>
                                Submit Guess
                            </button>
                            <button class="clear-btn" onclick="clearGuess()" disabled>
                                Clear
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCo-B6mpppmB0L_u6A4AqNmX0DjuqsPX9g&callback=initMap" async defer></script>
    <script>
        let map;
        let guessMarker = null; // Tracks the pin on the map
        let guessCoordinates = null; // Stores lat/lng of the pin

        function initMap() {
            const mapOptions = {
                center: { lat: {{ area_lat }}, lng: {{ area_lon }} },
                zoom: 10,
                streetViewControl: false,
                rotateControl: false,
                fullscreenControl: true,
            };

            map = new google.maps.Map(document.getElementById('map'), mapOptions);

            // 1. LISTENER: When user clicks map, place a pin
            map.addListener('click', function(event) {
                placePin(event.latLng);
            });
        }

        // 1. PLACE PIN: Remove old pin, add new pin, save coordinates
        function placePin(location) {
            // Remove old pin if it exists
            if (guessMarker) {
                guessMarker.setMap(null);
            }

            // Create new pin at clicked location
            guessMarker = new google.maps.Marker({
                position: location,
                map: map,
                title: "Your Guess"
            });

            // Save the lat/lng coordinates
            guessCoordinates = {
                lat: location.lat(),
                lng: location.lng()
            };

            // Enable the submit button
            document.getElementById('submitBtn').disabled = false;

            console.log("Pin placed at:", guessCoordinates); // For testing
        }

        // 2. SUBMIT BUTTON: Output the saved coordinates
        function submitGuess() {
            if (!guessCoordinates) {
                alert('Please place a pin on the map first!');
                return;
            }

            // Output the coordinates
            console.log("Submitted guess:", guessCoordinates);
            alert(`Your guess: ${guessCoordinates.lat}, ${guessCoordinates.lng}`);

            // Here you would send the coordinates to your Flask backend
            // sendGuessToServer(guessCoordinates);
        }

        // Optional: Clear the pin
        function clearGuess() {
            if (guessMarker) {
                guessMarker.setMap(null);
                guessMarker = null;
            }
            guessCoordinates = null;
            document.getElementById('submitBtn').disabled = true;
        }
    </script>
</body>
</html>